<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>AJAX with jQuery and cherrypy</title>
  <style type="text/css" title="currentStyle">
    @import "/media/css/demo_page.css";
    @import "/media/css/demo_table_jui.css";
    @import "/media/themes/smoothness/jquery-ui-1.7.2.custom.css";
  </style>
  <script type="text/javascript" src="/media/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="/media/blockUI/jquery.blockUI.js"></script>
  <!-- <script type="text/javascript" src="/media/jquery.js"></script> -->
  <script type="text/javascript" src="/media/jquery.dataTables.js"></script>
  <script type="text/javascript" src="/media/functions.js"></script>
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {

    var oTable;
    var trendsDir;
    var typeName = "RPC";
    var tagName = "HDQM_"+typeName+"_V1";

    $("#form").submit(function() {

	$.blockUI({ message: '<h1><img src="/media/images/bigrotation2.gif" /> Processing your request, please wait...</h1>' });

        var sData = "";
        var first = 0;
        var rows = oTable.fnGetNodes();
        // alert( "total rows in table = "+rows.length );
        for( i=0; i<rows.length; i++ ) {
            var row = rows[i];
            var lastCell = row.cells.length - 1;
            // alert( "row = " + row.cells[lastCell].childNodes[0].checked );
            if( row.cells[lastCell].childNodes[0].checked ) {
                if( first == 0 ) {first = 1;}
                else {sData += "&";}
                sData += $('input', oTable.fnGetNodes(i)).serialize();
                // alert( "row number " + i + " accepted " );
                // for( j = 0; j <= lastCell; j++ ) {
                //     alert( "oTable["+i+"]["+j+"] = " + row.cells[j].childNodes[0].data );
                // }
                // sData += row.cells.serialize();
            }
        }

        // var sData = $('input', oTable.fnGetNodes()).serialize();
        // alert( "The following data were submitted to the server: \n\n"+sData );

        var postdata = $('#first').serialize()+"&"+$('#last').serialize();
	$.ajax({
	  type: "POST",
	  url: '/submitForm/'+typeName+"/"+tagName,
	  data: postdata+"&"+sData,
          cache: false,
	  async: false,
	  success: function(data) {
	    $('.result').html(data);
	    trendsDir = data.split(":")[1];
	    var len = trendsDir.length;
	    trendsDir = trendsDir.substring(2, len-2);
	    // alert('Load was performed.'+trendsDir);
	  }
	});
	// $.post('/submitForm/'+tagName, postdata+"&"+sData);
        // $.post('/submitForm', postdata+"&"+sData, function(data) {
        //     alert( "the form name was set to " + postdata);
        // });

	$.unblockUI();
	window.open('/media/'+trendsDir+'/index.html')
	// window.open('/media/NewTrends/index.html')

        return false;
    });

    oTable = $('#example').dataTable( {
      "iDesplayLength": 50,
      "bProcessing": true,
      <!-- "sAjaxSource": '/media/json_source.txt', -->
      "sAjaxSource": '/tableFromJson/'+typeName+'FullList.txt',
      "bStateSave": true, <!-- save the state using cookies -->
      "bJQueryUI": true,
      "sPaginationType": "full_numbers",
      "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
        /* The $ sign is a shortcut for jQuery */
        var htmlString = '<input type="checkbox" name="check" value="'+aData[1]+'">'
        var htmlString2 = '<input type="text" name="textCheck" value="0">'
        $('td:eq(1)', nRow).html( htmlString2 );
        $('td:eq(2)', nRow).html( htmlString );
        return nRow;
      },
      "aoColumns": [
        null,
        null,
        {"sClass": "center"}
      ]
    });
    <!-- dataTable('#example') -->
    });
  </script>
</head>
<body id="dt_example">
<!--  <div id="container"> -->
    <h1 id="title">HDQM Web Interface for RPC</h1>
    <p>
      Select the variables you want to plot and the range of runs. Once done press the submit button to create the trend plots.
    </p>
    <!--	<div id="dynamic"> -->
    <div class="demo_jui">
      <form id="form">
	<div style="text-align:right; padding-bottom:1em;">
	  <button type="submit">Submit</button>
	</div>

	<label for="first">First Run:</label>
	<input type="text" name="first" id="first" value="0" />
	<label for="last">Last Run:</label>
	<input type="text" name="last" id="last" value="9999999"/>

	<!-- Note that the table is inside the form now -->
	<table cellpadding="0" cellspacing="0" border="0" class="display" id="example">
	  <thead>
	    <tr>
	      <th width="50%">Name</th>
	      <th width="25%">LogY (0=false)</th>
	      <th width="25%">Selected</th>
	    </tr>
	  </thead>
	  <tbody>
	    
	  </tbody>
	  <tfoot>
	  </tfoot>
	</table>
      </form>
<!--    </div> -->
  </div>
  
</body>
</html>
